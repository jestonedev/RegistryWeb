@using RegistryWeb.ViewModel;
@using System.Linq;
@model RegistryWeb.ViewModel.PaymentsVM;


@{
    var accounts = Model.Payments.Select(p => new { p.PaymentAccountNavigation.IdAccount, p.PaymentAccountNavigation.Account }).Distinct();
    var minDate = Model.Payments.Select(p => p.Date).Min().AddMonths(-1);
    var maxDate = Model.Payments.Select(p => p.Date).Max().AddMonths(1);
    var account = Model.Payments.FirstOrDefault(p => p.IdAccount == ViewBag.IdAccount)?.PaymentAccountNavigation;
    var paymentAccount = account?.Account;
    var title = "Информация по ЛС № " + paymentAccount;
    ViewData["Title"] = title;
}

@section validation
    {
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js" asp-append-version="true"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js" asp-append-version="true"></script>
}

@section Styles {
    <link href="~/lib/vis/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    <link href="~/css/payment.accounts.css" rel="stylesheet" type="text/css" />
}

<div class="card">
    <div class="card-header d-flex flex-column flex-lg-row">
        <label class="form-check-label h2 col-sm-12 col-lg-7 col-xl-7 pl-0">@ViewData["Title"]</label>

        <div class="col-sm-12 col-lg-5 col-xl-5 text-lg-right pl-0 pr-0 mt-2 mt-lg-0">
            @if (Model.RentObjects.ContainsKey(ViewBag.IdAccount))
            {
                <div class="btn-group" role="group" aria-label="Панель доступа">
                    <button class="btn btn-success dropdown-toggle" type="button" title="Здания и помещения" aria-label="Здания и помещения" id="registryBtn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="oi oi-home"></span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="registryBtn">
                        @{
                            var rentObjects = (List<Address>)Model.RentObjects[ViewBag.IdAccount];
                            var premisesIds = rentObjects.Where(r => r.AddressType == AddressTypes.Premise).Select(r => r.Id)
                                            .Union(rentObjects.Where(r => r.AddressType == AddressTypes.SubPremise).Select(r => r.IdParents["Premise"]))
                                            .Select(r => int.Parse(r));
                            var buildingIds = rentObjects.Where(r => r.AddressType == AddressTypes.Building).Select(r => r.Id)
                                            .Union(rentObjects.Where(r => r.AddressType == AddressTypes.Premise).Select(r => r.IdParents["Building"]))
                                            .Union(rentObjects.Where(r => r.AddressType == AddressTypes.SubPremise).Select(r => r.IdParents["Building"]))
                                            .Select(r => int.Parse(r));

                            foreach (int buildingId in buildingIds)
                            {
                                var btnTitle = "Здание";
                                if (buildingIds.Count() > 1)
                                {
                                    btnTitle += " № " + buildingId;
                                }

                                <a class="dropdown-item" title="@btnTitle" aria-label="@btnTitle"
                                   asp-controller="Buildings" asp-action="Details" asp-route-idBuilding="@buildingId" asp-route-returnUrl="@($"{Context.Request.Scheme}://{Context.Request.Host}{Context.Request.Path}{Context.Request.QueryString}")">@btnTitle</a>
                            }
                            foreach (int premisesId in premisesIds)
                            {
                                var btnTitle = "Помещение";
                                if (premisesIds.Count() > 1)
                                {
                                    btnTitle += " № " + premisesId;
                                }

                                <a class="dropdown-item" title="@btnTitle" aria-label="@btnTitle"
                                   asp-controller="Premises" asp-action="Details" asp-route-idPremises="@premisesId" asp-route-returnUrl="@($"{Context.Request.Scheme}://{Context.Request.Host}{Context.Request.Path}{Context.Request.QueryString}")">@btnTitle</a>
                            }
                        }
                    </div>
                </div>
            }
            <div class="btn-group" role="group" aria-label="Панель доступа">
                <div class="btn-group" role="group" aria-label="Панель доступа">
                    <button class="btn btn-dark dropdown-toggle" type="button" title="Связанные объекты" aria-label="Связанные объекты" id="objectsBtn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="oi oi-grid-two-up"></span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="objectsBtn">
                        <a class="dropdown-item" title="Претензионно-исковые работы" aria-label="Претензионно-исковые работы"
                           asp-controller="Claims" asp-action="Index" asp-route-filterOptions.IdAccount="@account?.IdAccount" asp-route-typeObject="Premise" asp-route-returnUrl="@($"{Context.Request.Scheme}://{Context.Request.Host}{Context.Request.Path}{Context.Request.QueryString}")">Претензионно-исковые работы</a>
                    </div>
                </div>

                <div class="btn-group" role="group" aria-label="Отчеты">
                    <button class="btn btn-success dropdown-toggle" type="button" title="Отчеты" aria-label="Отчеты" id="reportsBtn_@account?.IdAccount" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="oi oi-document"></span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="reportsBtn_@account?.IdAccount">
                        <a class="dropdown-item rr-report-request-to-bsk" href="#" title="Запрос в БКС" aria-label="Запрос в БКС" data-id-account="@account?.IdAccount">Запрос в БКС</a>
                        <a class="dropdown-item rr-report-calc-debt" href="#" title="Расчет суммы задолженности" aria-label="Расчет суммы задолженности" data-id-account="@account?.IdAccount">Расчет суммы задолженности</a>
                    </div>
                </div>
            </div>

            <div class="btn-group" role="group" aria-label="Панель доступа">
                @if (@ViewBag.ReturnUrl != null)
                {
                    <a class="form-control btn btn-primary" href="@ViewBag.ReturnUrl">Назад</a>
                }
                else
                {
                    <a class="form-control btn btn-primary" asp-controller="PaymentAccounts" asp-action="Index" asp-route-isBack="true">Назад</a>
                }

                <a href="#" data-for="PaymentAccountInfo" class="form-control btn btn-primary pa-toggler" title="Развернуть найм жилья" style="font-weight:bold;">∧</a>
            </div>
        </div>
    </div>
    <div class="card-body" id="PaymentAccountInfo">

        <div data-id-account="@ViewBag.IdAccount" data-account-count="@accounts.Count()"
             data-min-date="@minDate.ToString("yyyy-MM-dd")"
             data-max-date="@maxDate.ToString("yyyy-MM-dd")"
             id="PaymentsTimeline" style="height: 2em">
            <div class="text-center" id="PaymentsTimelineLoader"><i>Загрузка истории по лицевому счету</i></div>
        </div>

        @for (var i = 0; i < Model.Payments.Count(); i++)
        {
            var payment = Model.Payments.ElementAt(i);
            var rentObjects = @Model.RentObjects.Where(r => r.Key == ViewBag.IdAccount).SelectMany(r => r.Value);
            var address = "";
            if (rentObjects.Any())
            {
                address = rentObjects.Select(r => r.Text).Aggregate((acc, v) => acc + ", " + v);
            }

            <div class="pa-item mt-3"
                 data-date-display="@payment.Date.ToString("dd.MM.yyyy")" data-date="@payment.Date.ToString("yyyy-MM-dd")"
                 data-id="@i" style="display: none"
                 data-account="@payment.PaymentAccountNavigation.Account" data-id-account="@payment.IdAccount" data-crn="@payment.PaymentAccountNavigation.Crn"
                 data-raw-address="@payment.PaymentAccountNavigation.RawAddress" data-address="@address" data-tenant="@payment.Tenant"
                 data-total-area="@payment.TotalArea" data-living-area="@payment.LivingArea" data-prescribed="@payment.Prescribed"
                 data-input-total="@payment.BalanceInput" data-input-tenancy="@payment.BalanceTenancy" data-input-penalties="@payment.BalanceInputPenalties"
                 data-input-dgi="@payment.BalanceDgi" data-input-padun="@payment.BalancePadun" data-input-pkk="@payment.BalancePkk"
                 data-output-total="@payment.BalanceOutputTotal" data-output-tenancy="@payment.BalanceOutputTenancy" data-output-penalties="@payment.BalanceOutputPenalties"
                 data-output-dgi="@payment.BalanceOutputDgi" data-output-padun="@payment.BalanceOutputPadun" data-output-pkk="@payment.BalanceOutputPkk"
                 data-charging-total="@payment.ChargingTotal" data-charging-tenancy="@payment.ChargingTenancy" data-charging-penalties="@payment.ChargingPenalties"
                 data-charging-dgi="@payment.ChargingDgi" data-charging-padun="@payment.ChargingPadun" data-charging-pkk="@payment.ChargingPkk"
                 data-payment-tenancy="@payment.PaymentTenancy" data-payment-penalties="@payment.PaymentPenalties"
                 data-payment-dgi="@payment.PaymentDgi" data-payment-padun="@payment.PaymentPadun" data-payment-pkk="@payment.PaymentPkk"
                 data-transfer-balance="@payment.TransferBalance" data-recalc-tenancy="@payment.RecalcTenancy" data-recalc-penalties="@payment.RecalcPenalties"
                 data-recalc-dgi="@payment.RecalcDgi" data-recalc-padun="@payment.RecalcPadun" data-recalc-pkk="@payment.RecalcPkk">
            </div>
        }

        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between">
                <h3>Основные сведения</h3>
                <div class="btn-group" role="group">
                    <a href="#" data-for="GeneralInfo" class="form-control btn btn-primary pa-toggler" title="Развернуть панель основных сведений" style="font-weight:bold;">∨</a>
                </div>
            </div>
            <div class="card-body toggle-hide" id="GeneralInfo">
                <div class="row">
                    <div class="form-group col-sm-6 col-md-3">
                        <label class="rr-account-label">Лицевой счет</label>
                        <input class="form-control" id="PaymentAccount" disabled type="text" />
                    </div>
                    <div class="form-group col-sm-6 col-md-3">
                        <label class="rr-account-label">СРН</label>
                        <input class="form-control" id="PaymentCrn" disabled type="text" />
                    </div>
                    <div class="form-group col-md-6">
                        <label class="rr-account-label">Адерс по БКС</label>
                        <input class="form-control" id="PaymentRawAddress" disabled type="text" />
                    </div>
                </div>
                <div class="row">
                    <div class="form-group col-md-6">
                        <label class="rr-account-label">Наниматель</label>
                        <input class="form-control" id="PaymentTenant" disabled type="text" />
                    </div>
                    <div class="form-group col-md-6">
                        <label class="rr-account-label">Адерс по жилищному фонду</label>
                        <input class="form-control" id="PaymentAddress" disabled type="text" />
                    </div>
                </div>
                <div class="row">
                    <div class="form-group col-sm-6 col-md-3">
                        <label class="rr-account-label">Прописано</label>
                        <input class="form-control" id="PaymentPrescribed" disabled type="text" />
                    </div>
                    <div class="form-group col-sm-6 col-md-3">
                        <label class="rr-account-label">По состоянию на</label>
                        <input class="form-control" id="PaymentDate" disabled type="text" />
                    </div>
                    <div class="form-group col-sm-6 col-md-3">
                        <label class="rr-account-label">Общая площадь</label>
                        <input class="form-control" id="PaymentTotalArea" disabled type="text" />
                    </div>
                    <div class="form-group col-sm-6 col-md-3">
                        <label class="rr-account-label">Жилая площадь</label>
                        <input class="form-control" id="PaymentLivingArea" disabled type="text" />
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between">
                <h3>Информация о платеже</h3>
                <div class="btn-group" role="group">
                    <a href="#" data-for="PaymentsInfo" class="form-control btn btn-primary pa-toggler" title="Развернуть панель сведений о платеже" style="font-weight:bold;">∨</a>
                </div>
            </div>
            <div class="card-body toggle-hide" id="PaymentsInfo">
                <h5>Сальдо входящее</h5>
                <hr class="mt-1" />
                <div class="row">
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Итого</label>
                        <input class="form-control" id="PaymentBalanceInputTotal" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Найм</label>
                        <input class="form-control" id="PaymentBalanceInputTenancy" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Пени</label>
                        <input class="form-control" id="PaymentBalanceInputPenalties" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">ДГИ</label>
                        <input class="form-control" id="PaymentBalanceInputDgi" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Падун</label>
                        <input class="form-control" id="PaymentBalanceInputPadun" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">ПКК</label>
                        <input class="form-control" id="PaymentBalanceInputPkk" disabled type="text" />
                    </div>
                </div>
                <h5>Начисление</h5>
                <hr class="mt-1" />
                <div class="row">
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Итого</label>
                        <input class="form-control" id="PaymentChargingTotal" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Найм</label>
                        <input class="form-control" id="PaymentChargingTenancy" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Пени</label>
                        <input class="form-control" id="PaymentChargingPenalties" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">ДГИ</label>
                        <input class="form-control" id="PaymentChargingDgi" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Падун</label>
                        <input class="form-control" id="PaymentChargingPadun" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">ПКК</label>
                        <input class="form-control" id="PaymentChargingPkk" disabled type="text" />
                    </div>
                </div>
                <h5>Перерасчет</h5>
                <hr class="mt-1" />
                <div class="row">
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Перенос сальдо</label>
                        <input class="form-control" id="PaymentTransferBalance" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Найм</label>
                        <input class="form-control" id="PaymentRecalcTenancy" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Пени</label>
                        <input class="form-control" id="PaymentRecalcPenalties" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">ДГИ</label>
                        <input class="form-control" id="PaymentRecalcDgi" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Падун</label>
                        <input class="form-control" id="PaymentRecalcPadun" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">ПКК</label>
                        <input class="form-control" id="PaymentRecalcPkk" disabled type="text" />
                    </div>
                </div>
                <h5>Оплата</h5>
                <hr class="mt-1" />
                <div class="row">
                    <div class="form-group col-4 offset-2 col-lg-2">
                        <label class="rr-account-label">Найм</label>
                        <input class="form-control" id="PaymentTenancy" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Пени</label>
                        <input class="form-control" id="PaymentPenalties" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">ДГИ</label>
                        <input class="form-control" id="PaymentDgi" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Падун</label>
                        <input class="form-control" id="PaymentPadun" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">ПКК</label>
                        <input class="form-control" id="PaymentPkk" disabled type="text" />
                    </div>
                </div>
                <h5>Сальдо исходящее</h5>
                <hr class="mt-1" />
                <div class="row">
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Итого</label>
                        <input class="form-control" id="PaymentBalanceOutputTotal" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Найм</label>
                        <input class="form-control" id="PaymentBalanceOutputTenancy" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Пени</label>
                        <input class="form-control" id="PaymentBalanceOutputPenalties" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">ДГИ</label>
                        <input class="form-control" id="PaymentBalanceOutputDgi" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">Падун</label>
                        <input class="form-control" id="PaymentBalanceOutputPadun" disabled type="text" />
                    </div>
                    <div class="form-group col-4 col-lg-2">
                        <label class="rr-account-label">ПКК</label>
                        <input class="form-control" id="PaymentBalanceOutputPkk" disabled type="text" />
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between">
                <h3>Информация об исковых работах</h3>
                <div class="btn-group" role="group">
                    <a href="#" data-for="ClaimsInfo" class="form-control btn btn-primary pa-toggler" title="Развернуть панель сведений о претензионно-исковых работах" style="font-weight:bold;">∨</a>
                </div>
            </div>
            <ul class="list-group list-group-flush toggle-hide" id="ClaimsInfo">
                @if (Model.ClaimsByAddresses.ContainsKey(ViewBag.IdAccount))
                {
                    var claims = Model.ClaimsByAddresses[ViewBag.IdAccount];
                    foreach (ClaimInfo claim in claims)
                    {
                        <li class="list-group-item">
                            <div class="row">
                                <div class="form-group col-12 col-lg-5">
                                    <label class="rr-account-label">Текущеее состояние</label>
                                    <input class="form-control" disabled type="text" value="@claim.ClaimCurrentState" />
                                </div>
                                <div class="form-group col-6 col-sm-5 col-lg-3">
                                    <label class="rr-account-label">Предьявлен период (с)</label>
                                    <input class="form-control" disabled type="text" value="@claim.StartDeptPeriod?.ToString("dd.MM.yyyy")" />
                                </div>
                                <div class="form-group col-6 col-sm-5 col-lg-3">
                                    <label class="rr-account-label">Предьявлен период (по)</label>
                                    <input class="form-control" disabled type="text" value="@claim.EndDeptPeriod?.ToString("dd.MM.yyyy")" />
                                </div>
                                <div class="col-12 col-sm-2 col-lg-1 text-center text-sm-right">
                                    <a class="btn btn-primary pa-open-claim-btn" asp-action="Details" asp-controller="Claims" asp-route-idClaim="@claim.IdClaim">
                                        <span class="oi oi-eye"></span>
                                    </a>
                                </div>
                            </div>
                        </li>
                    }
                }
                else
                {
                    <li class="list-group-item text-center rr-list-group-item-empty">
                        <i>Исковые работы отсутствуютт</i>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>

<partial name="ReportsModals">

    @section Scripts {
        <script src="~/lib/moment.js/moment-with-locales.min.js"></script>
        <script src="~/lib/vis/vis.min.js"></script>
        <script src="~/js/paymentAccounts.common.js"></script>
        <script src="~/js/paymentAccount.reports.js" asp-append-version="true"></script>
    }
